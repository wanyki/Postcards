<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>v2.1.1 æ•°æ®æ¬å®¶å·¥å…·</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .log-item { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        .success { color: green; }
        .error { color: red; font-weight: bold; }
        .stats { background: #f4f4f4; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #0070f3; color: white; border: none; border-radius: 5px; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
    <h1>ğŸš€ æ•°æ®åº“è¿ç§»å·¥å…· (v2.1.1)</h1>
    
    <div class="stats">
        <p><strong>æ£€æµ‹çŠ¶æ€ï¼š</strong> <span id="check-status">æ­£åœ¨è¯»å– data.js...</span></p>
        <p><strong>æ•°æ®æ€»é‡ï¼š</strong> <span id="data-count">0</span> æ¡</p>
        <button id="start-btn" disabled>ç¡®è®¤æ— è¯¯ï¼Œå¼€å§‹æ¬å®¶</button>
    </div>

    <div id="log"></div>

    <script src="data.js"></script>

    <script>
        const logDiv = document.getElementById('log');
        const startBtn = document.getElementById('start-btn');
        const countSpan = document.getElementById('data-count');
        const statusSpan = document.getElementById('check-status');

        // ã€å…³é”®ã€‘åŒ¹é…ä½  data.js é‡Œçš„å˜é‡å postcardData
        const sourceData = typeof postcardData !== 'undefined' ? postcardData : [];

        // åˆå§‹åŒ–æ£€æµ‹
        if (sourceData.length > 0) {
            statusSpan.innerText = "âœ… å·²æˆåŠŸè¯†åˆ« postcardData å˜é‡ï¼";
            statusSpan.style.color = "green";
            countSpan.innerText = sourceData.length;
            startBtn.disabled = false;
        } else {
            statusSpan.innerText = "âŒ æ‰¾ä¸åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥ data.js æ˜¯å¦åŒ…å« postcardData å˜é‡";
            statusSpan.style.color = "red";
        }

        // æ¬å®¶é€»è¾‘
        startBtn.onclick = async () => {
            const password = prompt("è¯·è¾“å…¥ä½ åœ¨ Vercel è®¾ç½®çš„ ADMIN_PASSWORD");
            if (!password) return;

            startBtn.disabled = true;
            logDiv.innerHTML = "<h3>å¼€å§‹åŒæ­¥...</h3>";

            // ä¸ºäº†é˜²æ­¢è¯·æ±‚è¿‡å¿«å¯¼è‡´æ•°æ®åº“å‹åŠ›ï¼Œæˆ‘ä»¬æŒ‰é¡ºåºä¸€æ¡æ¡å‘
            for (let i = 0; i < sourceData.length; i++) {
                const card = sourceData[i];
                try {
                    const res = await fetch('/api/add-cards', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password: password,
                            newCard: card
                        })
                    });
                    
                    const result = await res.json();
                    
                    const p = document.createElement('div');
                    p.className = 'log-item';
                    if (res.ok) {
                        p.innerHTML = `<span class="success">âœ… [${i+1}/${sourceData.length}] æˆåŠŸ: ${card.id} (${card.region})</span>`;
                    } else {
                        p.innerHTML = `<span class="error">âŒ [${i+1}/${sourceData.length}] å¤±è´¥: ${card.id} - ${result.error}</span>`;
                    }
                    logDiv.prepend(p); // æœ€æ–°çš„æ—¥å¿—æ˜¾ç¤ºåœ¨ä¸Šé¢
                } catch (e) {
                    console.error(e);
                    const p = document.createElement('div');
                    p.className = 'log-item error';
                    p.innerText = `ğŸ’¥ ç½‘ç»œé”™è¯¯: ${e.message}`;
                    logDiv.prepend(p);
                }
            }

            logDiv.innerHTML = "<h2>ğŸŠ å…¨éƒ¨è¿ç§»ä»»åŠ¡å·²å®Œæˆï¼</h2>" + logDiv.innerHTML;
        };
    </script>
</body>
</html>